<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>4段階愛着診断（デバッグ最小版）</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
:root{ --rose50:#fff1f2; --rose100:#ffe4e6; --rose200:#fecdd3; --rose300:#fda4af;
  --rose400:#fb7185; --rose500:#f43f5e; --rose600:#e11d48 }
*{ box-sizing:border-box } body{ margin:0; font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Meiryo,sans-serif;
  background:linear-gradient(#fff,var(--rose50)); color:#374151 }
.wrap{ max-width:940px; margin:0 auto; padding:20px 16px 56px }
.h1{ font-weight:800; color:var(--rose600); font-size:clamp(22px,4vw,32px); text-align:center; margin:18px 0 12px }
.card{ background:#fff; border:1px solid var(--rose200); border-radius:16px; padding:14px }
.mini{display:flex; justify-content:space-between; font-size:12px; color:#fb7185; margin-bottom:6px}
.progress{height:8px; background:var(--rose100); border-radius:999px; overflow:hidden}
.progress>div{ height:100%; background:var(--rose400) }
.choices{ display:flex; flex-direction:column; gap:10px }
.choice{ border:1px solid var(--rose200); border-radius:12px; padding:12px; background:#fff; text-align:left; cursor:pointer }
.choice.selected{ border-color:var(--rose400); background:#fff5f6 }
.nav{ display:flex; justify-content:space-between; gap:8px; margin-top:12px }
.btn{ border:none; border-radius:10px; padding:9px 14px; font-weight:700; cursor:pointer }
.btn-ghost{ background:#fff; border:1px solid var(--rose200) }
.btn-primary{ background:var(--rose500); color:#fff }
.btn-primary:disabled{ background:var(--rose300); cursor:not-allowed }
.err{ background:#fff1f2; border:1px solid #fda4af; color:#b91c1c; border-radius:12px; padding:12px; margin-bottom:12px; white-space:pre-wrap }
.kpi{ background:#fff; border:1px solid var(--rose200); border-radius:12px; padding:10px; margin-top:10px }
canvas{ max-width:100% }
</style>
</head>
<body>
<div class="wrap" id="app">
  <div class="h1">4段階愛着診断</div>
  <div id="error"></div>
</div>

<script>
(function(){
  "use strict";
  const app = document.getElementById("app");
  const errorBox = document.getElementById("error");

  // 画面にエラーを見せる
  function showError(e){
    const msg = (e && e.stack) ? e.stack : (e && e.message) ? e.message : String(e);
    errorBox.innerHTML = '<div class="err">エラー: ' + msg + '</div>';
  }
  window.addEventListener("error", ev => { showError(ev.error || ev.message); });
  window.addEventListener("unhandledrejection", ev => { showError(ev.reason); });

  try {
    // ======= デモ用：第1段階 3問だけ（まず映ること優先） =======
    const stage1 = [
      {
        stem: "過去の恋愛で、返信が遅かったときの行動は？",
        choices: [
          {label:"何度も連絡してしまった（不安）", style:"anxious", pt:2},
          {label:"そっけない返信で距離をとった（回避）", style:"avoidant", pt:2},
          {label:"平気を装ったが内心不安（恐れ回避）", style:"fearful", pt:2},
          {label:"忙しいのだろうと落ち着いて待てた（安定）", style:"secure", pt:0},
        ]
      },
      {
        stem: "『一人の時間が欲しい』と言われたとき？",
        choices: [
          {label:"『嫌われた？』とパニック（不安）", style:"anxious", pt:3},
          {label:"『じゃあ自分も自由に』と距離（回避）", style:"avoidant", pt:2},
          {label:"表面はOKだが内心不安（恐れ回避）", style:"fearful", pt:2},
          {label:"尊重して自分時間へ（安定）", style:"secure", pt:0},
        ]
      },
      {
        stem: "相手の態度が急に冷たくなったと感じたとき？",
        choices: [
          {label:"理由を何度も確認（不安）", style:"anxious", pt:2},
          {label:"『もういい』と突き放す（回避）", style:"avoidant", pt:2},
          {label:"平気を装い様子見（恐れ回避）", style:"fearful", pt:2},
          {label:"落ち着いて話す場をつくる（安定）", style:"secure", pt:0},
        ]
      },
    ];

    let idx = 0;
    const answers = []; // {q, style, pt}

    render();

    function render(){
      // クリア
      app.innerHTML = '<div class="h1">4段階愛着診断</div><div id="error"></div>';
      const errMount = document.getElementById("error");
      if(errorBox && errMount && errorBox.innerHTML) errMount.innerHTML = errorBox.innerHTML;

      if(idx >= stage1.length){
        return renderResult();
      }

      // 進捗
      const prog = document.createElement("div");
      prog.className = "card";
      prog.innerHTML =
        '<div class="mini"><div>進捗</div><div>'+(idx+1)+'/'+stage1.length+'（'+Math.round(((idx+1)/stage1.length)*100)+'%）</div></div>'+
        '<div class="progress"><div style="width:'+(((idx+1)/stage1.length)*100)+'%"></div></div>';
      app.appendChild(prog);

      // 質問
      const q = stage1[idx];
      const card = document.createElement("div");
      card.className = "card";
      const h2 = document.createElement("h2");
      h2.textContent = q.stem;
      card.appendChild(h2);

      const choices = document.createElement("div");
      choices.className = "choices";
      q.choices.forEach((c, i) => {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = c.label;
        btn.onclick = () => {
          const pos = answers.findIndex(a=>a.q===idx);
          const rec = { q: idx, style: c.style, pt: c.pt };
          if(pos>=0) answers.splice(pos,1,rec); else answers.push(rec);
          [...choices.children].forEach(x=>x.classList.remove("selected"));
          btn.classList.add("selected");
          nextBtn.disabled = false;
        };
        choices.appendChild(btn);
      });
      card.appendChild(choices);

      // ナビ
      const nav = document.createElement("div");
      nav.className = "nav";
      const back = document.createElement("button");
      back.className = "btn btn-ghost";
      back.textContent = "戻る";
      back.onclick = () => { if(idx>0){ idx--; render(); } };
      const nextBtn = document.createElement("button");
      nextBtn.className = "btn btn-primary";
      nextBtn.textContent = (idx+1===stage1.length) ? "結果を見る" : "次へ";
      nextBtn.disabled = answers.findIndex(a=>a.q===idx) < 0;
      nextBtn.onclick = () => { idx++; render(); };
      nav.appendChild(back); nav.appendChild(nextBtn);
      card.appendChild(nav);

      app.appendChild(card);
    }

    function renderResult(){
      // 集計
      const sum = { anxious:0, avoidant:0, fearful:0, secure:0 };
      answers.forEach(a => { sum[a.style] += a.pt; });
      const max = stage1.length * 3; // 安定(0)以外は最大3点
      const pct = {
        anxious: Math.round((sum.anxious / max) * 100),
        avoidant: Math.round((sum.avoidant / max) * 100),
        fearful:  Math.round((sum.fearful  / max) * 100),
        secure:   Math.round((sum.secure   / max) * 100),
      };
      const radar = {
        anxious: Math.min(100, pct.anxious + 10),
        avoidant: Math.min(100, pct.avoidant + 10),
        fearful: Math.min(100, pct.fearful + 10),
        secure: Math.min(100, pct.secure + 10),
      };
      const order = Object.entries(pct).sort((a,b)=>b[1]-a[1]);
      const dom = order[0][0];
      const map = { anxious:"不安", avoidant:"回避", fearful:"恐れ回避", secure:"安定" };

      // 画面
      const head = document.createElement("div");
      head.className = "card";
      head.innerHTML = '<div class="kpi">優勢タイプ：<b>'+map[dom]+'</b></div>';
      app.appendChild(head);

      const radarCard = document.createElement("div");
      radarCard.className = "card";
      radarCard.innerHTML = '<canvas id="radar" height="260"></canvas>';
      app.appendChild(radarCard);

      const ctx = document.getElementById("radar");
      new Chart(ctx, {
        type: "radar",
        data: {
          labels: ["不安","回避","恐れ回避","安定"],
          datasets: [{
            data: [radar.anxious, radar.avoidant, radar.fearful, radar.secure],
            fill: true,
            borderColor: "rgba(244,63,94,1)",
            backgroundColor: "rgba(244,63,94,.22)",
            pointRadius: 3,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { r: {
            suggestedMin: 0, suggestedMax: 100,
            ticks: { stepSize: 25, backdropColor: "transparent" },
            grid: { color: "rgba(244,63,94,.15)" },
            angleLines: { color: "rgba(244,63,94,.25)" }
          } }
        }
      });

      const back = document.createElement("div");
      back.className = "card";
      back.innerHTML = '<button class="btn btn-ghost" onclick="location.reload()">最初からやり直す</button>';
      app.appendChild(back);
    }
  } catch(e){
    showError(e);
  }
})();
</script>
</body>
</html>
