<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>4段階愛着診断（全段階フル）</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
:root{
  --rose50:#fff1f2; --rose100:#ffe4e6; --rose200:#fecdd3; --rose300:#fda4af;
  --rose400:#fb7185; --rose500:#f43f5e; --rose600:#e11d48;
}
*{ box-sizing:border-box }
html,body{ height:100% }
body{
  margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Hiragino Kaku Gothic ProN,Yu Gothic,Meiryo,system-ui,sans-serif;
  color:#3f3f46; background:var(--rose50); /* 淡いピンク一色 */
}
.wrap{ max-width:940px; margin:0 auto; padding:20px 16px 56px }
.h1{ font-weight:800; color:#be123c; font-size:clamp(22px,4vw,32px); text-align:center; margin:18px 0 6px }
.card{
  background:#fff; border:1px solid var(--rose200); border-radius:18px; padding:16px 14px;
  box-shadow: 0 10px 32px rgba(244,63,94,.08), 0 0 0 1px rgba(244,63,94,.04);
}
.card + .card{ margin-top:14px }
.stage{font-weight:700; font-size:13px; color:#be123c; margin:0 2px 8px}
.small{ font-size:12px; color:#6b7280 }
.mini{ display:flex; justify-content:space-between; font-size:12px; color:#fb7185; margin-bottom:6px }
.progress{ height:8px; background:var(--rose100); border-radius:999px; overflow:hidden }
.progress>div{ height:100%; background:var(--rose400) }
h2.q{ font-weight:800; color:#991b1b; line-height:1.5; letter-spacing:.02em; margin:6px 2px 14px }
.choices{ display:flex; flex-direction:column; gap:10px }
.choice{
  border:1px solid var(--rose200); background:#fff; border-radius:14px; padding:14px 12px; text-align:left; font-size:15px;
  cursor:pointer; transition:.15s box-shadow,.15s transform,.15s border-color
}
.choice:hover{ border-color:var(--rose300); transform:translateY(-1px) }
.choice.selected{ border-color:var(--rose400); background:linear-gradient(#fff, #fff5f6) }
.nav{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:16px }
.btn{ border:none; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer }
.btn-ghost{ background:#fff; border:1px solid var(--rose200) }
.btn-primary{ background:var(--rose500); color:#fff }
.btn-primary:disabled{ background:var(--rose300); cursor:not-allowed }
.kpi{ background:#fff; border:1px solid var(--rose200); border-radius:14px; padding:10px 12px }
.result-grid{ display:grid; gap:10px }
.badge{ display:inline-block; background:#fff; border:1px solid var(--rose200); color:#be123c; border-radius:999px; padding:6px 10px; font-weight:700 }
.hr{ height:1px; background:var(--rose200); margin:14px 0 }
.center{text-align:center}
.err{ background:#fff1f2; border:1px solid #fda4af; color:#b91c1c; border-radius:12px; padding:12px; margin:10px 0; white-space:pre-wrap }
canvas{ max-width:100% }
</style>
</head>
<body>
<div class="wrap" id="app">
  <div class="h1">4段階愛着診断</div>
  <div id="error"></div>
</div>
<script>
(function(){
"use strict";
const app=document.getElementById("app");
const errorBox=document.getElementById("error");
function showError(e){ const msg=(e&&e.stack)?e.stack:(e&&e.message)?e.message:String(e); errorBox.innerHTML='<div class="err">エラー: '+msg+'</div>'; }
window.addEventListener("error",ev=>showError(ev.error||ev.message));
window.addEventListener("unhandledrejection",ev=>showError(ev.reason));

/* ========= ユーティリティ ========= */
const W = { strong:3, mid:2, weak:1, stable:0 };
const STY = { anxious:'不安', avoidant:'回避', fearful:'恐れ回避', secure:'安定' };
function imp(label, n){ return { kind:"imp", label, imp:n }; }      // 第2
function stb(label, n){ return { kind:"stb", label, stable:n }; }   // 第3
function pair(id, stemA, stemB, flavor, Aopts, Bopts){
  const mk = (stem, ab, opts)=>({
    pairId:id, ab, stem,
    choices: opts.map(([risk,label])=>({ kind:"risk", label, risk, flavor }))
  });
  return [ mk(stemA,"A",Aopts), mk(stemB,"B",Bopts) ];
}
function divCard(html){ const c=document.createElement("div"); c.className="card"; c.innerHTML=html; return c; }
function progressCard(i, len){
  const c=document.createElement("div"); c.className="card";
  c.innerHTML = `<div class="mini"><div>進捗</div><div>${i+1}/${len}（${Math.round(((i+1)/len)*100)}%）</div></div>
  <div class="progress"><div style="width:${((i+1)/len)*100}%"></div></div>`;
  return c;
}

/* ========= 第1段階：60問（ここにあなたの60問を貼ってください） ========= */
/* 形式：{ stem:"...", choices:[ {label:"...", style:"anxious|avoidant|fearful|secure", pt:0..3}, ... ] } */
const stage1 = [
  /* ▼ 例の3問（動作確認用）。ここをあなたの60問配列に置換してください。 */
  {
    stem: "過去の恋愛で、返信が遅かったときの行動は？",
    choices: [
      {label:"何度も連絡してしまった（不安）", style:"anxious", pt:W.mid},
      {label:"そっけない返信で距離をとった（回避）", style:"avoidant", pt:W.mid},
      {label:"平気を装ったが内心不安（恐れ回避）", style:"fearful", pt:W.mid},
      {label:"忙しいのだろうと落ち着いて待てた（安定）", style:"secure", pt:W.stable},
    ]
  },
  {
    stem: "『一人の時間が欲しい』と言われたとき？",
    choices: [
      {label:"『嫌われた？』とパニック（不安）", style:"anxious", pt:W.strong},
      {label:"『じゃあ自分も自由に』と距離（回避）", style:"avoidant", pt:W.mid},
      {label:"表面はOKだが内心不安（恐れ回避）", style:"fearful", pt:W.mid},
      {label:"尊重して自分時間へ（安定）", style:"secure", pt:W.stable},
    ]
  },
  {
    stem: "相手の態度が急に冷たくなったと感じたとき？",
    choices: [
      {label:"理由を何度も確認（不安）", style:"anxious", pt:W.mid},
      {label:"『もういい』と突き放す（回避）", style:"avoidant", pt:W.mid},
      {label:"平気を装い様子見（恐れ回避）", style:"fearful", pt:W.mid},
      {label:"落ち着いて話す場をつくる（安定）", style:"secure", pt:W.stable},
    ]
  },
];

/* ========= 第2段階：成長・改善度（20問） ========= */
/* imp: 0=変化なし/悪化, 1=少し成長, 2=かなり成長, 3=大きく成長 */
const stage2 = [
  { stem:"昔より、不安時に自分で落ち着ける？",
    choices:[ imp("ほとんど変わらない",0), imp("少しできる",1), imp("かなりできる",2), imp("ほぼ自動で整う",3) ] },
  { stem:"依存的な行動（追撃LINEなど）は以前と比べて？",
    choices:[ imp("変わらない/増えた",0), imp("やや減った",1), imp("だいぶ減った",2), imp("ほぼ無くなった",3) ] },
  { stem:"率直な気持ちの伝達は？",
    choices:[ imp("ほぼできない",0), imp("短くならできる",1), imp("具体に伝えられる",2), imp("タイミングも選べる",3) ] },
  { stem:"疑う気持ちの扱いは？",
    choices:[ imp("衝動強く繰り返す",0), imp("衝動は減った",1), imp("言語化して話せる",2), imp("飲まれず選べる",3) ] },
  { stem:"衝突時、感情をぶつけず話し合える？",
    choices:[ imp("ぶつけてしまう",0), imp("時々は落ち着ける",1), imp("かなり落ち着ける",2), imp("目的思考で対話",3) ] },
  { stem:"相手の『一人時間ほしい』を受け止められる？",
    choices:[ imp("不安で崩れる",0), imp("我慢して合わせる",1), imp("理解し整える",2), imp("自然に尊重できる",3) ] },
  { stem:"過去と比べて、返信が遅くても待てる？",
    choices:[ imp("全く待てない",0), imp("少しは待てる",1), imp("だいぶ待てる",2), imp("落ち着いて待てる",3) ] },
  { stem:"“相手を試す行動”（無視/駆け引き）は？",
    choices:[ imp("よくやってしまう",0), imp("やや減った",1), imp("かなり減った",2), imp("ほぼ無い",3) ] },
  { stem:"自分の活動（仕事/趣味）との両立は？",
    choices:[ imp("恋愛に飲まれがち",0), imp("少し両立",1), imp("大体両立",2), imp("安定して両立",3) ] },
  { stem:"“不安の再評価”（考え直し）ができる？",
    choices:[ imp("できない",0), imp("少しできる",1), imp("かなりできる",2), imp("自然にできる",3) ] },
  { stem:"既読無視でも自分を保てる？",
    choices:[ imp("保てない",0), imp("時々保てる",1), imp("多くで保てる",2), imp("ほぼ保てる",3) ] },
  { stem:"『会えない』時の心の扱い方は？",
    choices:[ imp("崩れやすい",0), imp("少し崩れる",1), imp("立て直せる",2), imp("安定維持できる",3) ] },
  { stem:"嫉妬の扱い方は？",
    choices:[ imp("振り回される",0), imp("抑えにくいが減った",1), imp("言語化し話せる",2), imp("選択的に扱える",3) ] },
  { stem:"『不安＝危険』と短絡しにくくなった？",
    choices:[ imp("短絡しがち",0), imp("やや改善",1), imp("かなり改善",2), imp("ほぼ短絡しない",3) ] },
  { stem:"沈黙・放置に耐える力は？",
    choices:[ imp("耐えられない",0), imp("少し耐えられる",1), imp("だいぶ耐えられる",2), imp("十分耐えられる",3) ] },
  { stem:"話し合い時、攻撃/回避を選ばず居続けられる？",
    choices:[ imp("難しい",0), imp("少し増えた",1), imp("かなり増えた",2), imp("安定して出来る",3) ] },
  { stem:"“安心できる人選び”は上手くなった？",
    choices:[ imp("変わらない",0), imp("少し上手く",1), imp("かなり上手く",2), imp("かなり精度高い",3) ] },
  { stem:"“境界線（バウンダリー）”の設定は？",
    choices:[ imp("設定できない",0), imp("少し設定",1), imp("大体設定",2), imp("自然に設定",3) ] },
  { stem:"『失う不安』への耐性は？",
    choices:[ imp("とても弱い",0), imp("やや弱い",1), imp("ふつう",2), imp("十分ある",3) ] },
  { stem:"“感情の波”が来ても戻せる？",
    choices:[ imp("戻せない",0), imp("時々戻せる",1), imp("大体戻せる",2), imp("自分でコントロール可",3) ] },
];

/* ========= 第3段階：ストレス下の安定（20問） ========= */
/* stable: 0=不安定, 1=やや不安定, 2=やや安定, 3=安定 */
const stage3 = [
  { stem:"好きな人から3日返信なし。反応は？",
    choices:[ stb("連投/パニック",0), stb("諦めて距離",1), stb("気にしつつ待つ",2), stb("気になるが落ち着いて待つ",3) ] },
  { stem:"『少し距離を置きたい』と言われた",
    choices:[ stb("何度も連絡/詰める",0), stb("冷めたふりで距離",1), stb("不安抱えつつ様子見",2), stb("受け止め自分時間へ",3) ] },
  { stem:"強い不安に襲われた時のセルフケア",
    choices:[ stb("相手へぶつける",0), stb("投げやりに避ける",1), stb("一人で抱える",1), stb("呼吸/記録/再評価",3) ] },
  { stem:"一人の休日、恋愛の事ばかり考える？",
    choices:[ stb("ずっと考える",0), stb("長めに引きずる",1), stb("切替できる時間がある",2), stb("自分の活動に集中",3) ] },
  { stem:"SNSで不安になる頻度",
    choices:[ stb("頻繁にある",0), stb("時々ある",1), stb("たまにある",2), stb("ほぼ無い",3) ] },
  { stem:"ケンカ時の対処",
    choices:[ stb("感情的に爆発",0), stb("無視/距離を取る",1), stb("我慢して沈黙",1), stb("休憩→合意形成の対話",3) ] },
  { stem:"未読/既読スルー時の睡眠",
    choices:[ stb("眠れない",0), stb("浅くなる",1), stb("少し影響",2), stb("ほぼ影響なし",3) ] },
  { stem:"体調不良でも自分のケアを続けられる？",
    choices:[ stb("続けられない",0), stb("時々できる",1), stb("大体できる",2), stb("きちんと継続",3) ] },
  { stem:"『会えない』が続く時の心の安定",
    choices:[ stb("崩れる",0), stb("不安定が続く",1), stb("揺れはあるが戻る",2), stb("自分で整えられる",3) ] },
  { stem:"相手が他の異性と仲良いのを見た時",
    choices:[ stb("詰める/連投",0), stb("距離/拗ねる",1), stb("気にしつつ様子見",2), stb("信頼し対話へ",3) ] },
  { stem:"相手の短文返信が続く時",
    choices:[ stb("パニック/確認攻め",0), stb("冷たい対応で返す",1), stb("落ち込み待つ",2), stb("事情と捉え落ち着く",3) ] },
  { stem:"忙しい/多忙アピールを受け取った時",
    choices:[ stb("見捨て不安で混乱",0), stb("距離で対抗",1), stb("気にしつつ待つ",2), stb("尊重し自分時間へ",3) ] },
  { stem:"ケンカ直後、すぐに仲直り要求されたら",
    choices:[ stb("爆発/応戦",0), stb("避ける/引く",1), stb("曖昧に応じる",2), stb("一旦休止→話し合い",3) ] },
  { stem:"“沈黙戦略”を感じた時",
    choices:[ stb("連投/詰める",0), stb("同じく沈黙で返す",1), stb("待ちながら整える",2), stb("境界提案しつつ整える",3) ] },
  { stem:"不安で食事や仕事に影響が出る？",
    choices:[ stb("大きく出る",0), stb("時々出る",1), stb("軽度に出る",2), stb("ほぼ出ない",3) ] },
  { stem:"期待外れ（記念日忘れ等）の時",
    choices:[ stb("責める/試す",0), stb("冷淡に振る舞う",1), stb("落ち込みつつ提案",2), stb("感情整理後に提案",3) ] },
  { stem:"“別れ”が頭をよぎる時の扱い",
    choices:[ stb("衝動で口にする",0), stb("距離で揺さぶる",1), stb("考えを記録",2), stb("対話の場を作る",3) ] },
  { stem:"相手の元恋人の話題",
    choices:[ stb("詰める/比較する",0), stb("拗ねる/距離",1), stb("気にしつつ受け流す",2), stb("落ち着いて聞ける",3) ] },
  { stem:"“不確かな情報”に反応する時",
    choices:[ stb("最悪を決めつける",0), stb("疑いに飲まれる",1), stb("再評価を試みる",2), stb("事実確認→再評価",3) ] },
  { stem:"長期的な安定の“再現性”",
    choices:[ stb("ほぼ無い",0), stb("ムラが大きい",1), stb("おおむね再現可",2), stb("安定して再現可",3) ] },
];

/* ========= 第4段階：隠れタイプ（10ペア = 20問） ========= */
/* flavor: 'anx' = 不安系上振れ, 'avo' = 回避系上振れ。B(恋愛中)−A(普段) を集計。 */
const stage4_pairs = [
  // 1: 返信が遅い（不安）
  pair("p1","（普段）返信が遅い状況の自分","（恋愛中）好きな人の返信が遅い時",'anx',
    [[0,"あまり気にしない"],[1,"少し気になる"],[2,"落ち着かなくなる"],[3,"不安になりやすい"]],
    [[0,"落ち着いて待てる"],[1,"気になるが待てる"],[2,"何度も確認する"],[3,"嫌われ不安で連投したい"]]),
  // 2: 一人時間（不安）
  pair("p2","（普段）一人時間の扱い","（恋愛中）相手に一人時間と言われたら",'anx',
    [[0,"自然に確保できる"],[1,"時々不安"],[2,"孤独感が出やすい"],[3,"心細さが強い"]],
    [[0,"尊重して待てる"],[1,"少し不安だが整えられる"],[2,"不安で落ち着かない"],[3,"拒絶感でパニック"]]),
  // 3: 親密要求（回避）
  pair("p3","（普段）親密な話題/距離が近い時","（恋愛中）相手が密に繋がりたがる時",'avo',
    [[0,"大丈夫"],[1,"少し逃げたくなる"],[2,"避けがち"],[3,"強く引きたくなる"]],
    [[0,"ペース相談できる"],[1,"負担だが話せる"],[2,"返信/会う頻度を下げる"],[3,"急に距離を空ける"]]),
  // 4: 将来の話（回避）
  pair("p4","（普段）将来の話題（結婚/同棲など）","（恋愛中）相手が将来を具体化する時",'avo',
    [[0,"抵抗はない"],[1,"少し緊張"],[2,"避けたい"],[3,"逃げたくなる"]],
    [[0,"話せる/計画できる"],[1,"話題を変えることがある"],[2,"先延ばしにする"],[3,"距離を置く"]]),
  // 5: 嫉妬刺激（不安）
  pair("p5","（普段）他者の成功/比較を見た時","（恋愛中）相手が異性と仲良くする時",'anx',
    [[0,"影響は小さい"],[1,"少し不安"],[2,"落ち込みやすい"],[3,"強く不安"]],
    [[0,"信頼し対話できる"],[1,"気になるが話せる"],[2,"確認/詰めたくなる"],[3,"強い不安で連投"]]),
  // 6: 既読・未読（不安）
  pair("p6","（普段）連絡の既読/未読","（恋愛中）未読/既読スルーが続く時",'anx',
    [[0,"あまり気にしない"],[1,"少し気になる"],[2,"落ち着かない"],[3,"強く気にする"]],
    [[0,"落ち着いて待つ"],[1,"待てるが気になる"],[2,"連投したくなる"],[3,"確かめずにいられない"]]),
  // 7: 依頼/お願い（回避）
  pair("p7","（普段）助けや配慮を頼むこと","（恋愛中）相手に配慮を求める時",'avo',
    [[0,"普通に頼める"],[1,"やや苦手"],[2,"避けがち"],[3,"頼めない"]],
    [[0,"率直に頼める"],[1,"遠回しになる"],[2,"黙って距離"],[3,"急に引く/消える"]]),
  // 8: 謝罪/修復（回避）
  pair("p8","（普段）自分の非の認めやすさ","（恋愛中）ケンカ後の謝罪/修復",'avo',
    [[0,"認めやすい"],[1,"少し躊躇"],[2,"認めにくい"],[3,"拒否したい"]],
    [[0,"早めに修復行動"],[1,"時間を置く"],[2,"避け続ける"],[3,"話し合いを拒否"]]),
  // 9: 拒絶想像（不安）
  pair("p9","（普段）拒絶/否定の想像への反応","（恋愛中）相手の冷たさを感じた時",'anx',
  [[0,"再評価できる"],[1,"少し沈む"],[2,"長く引きずる"],[3,"強く囚われる"]],
  [[0,"状況を確認する"],[1,"落ち込むが整理"],[2,"確かめたくなる"],[3,"パニック/詰問"]]
),
  // 10: 距離・空白（回避）
  pair("p10","（普段）空白時間や沈黙","（恋愛中）連絡が途切れる/会えない期間",'avo',
    [[0,"平気に過ごせる"],[1,"少しソワソワ"],[2,"避けに傾く"],[3,"強く閉じる"]],
    [[0,"自分時間で過ごす"],[1,"様子見で待てる"],[2,"距離を増やす"],[3,"急に切る/消える"]]),
];
// フラット化
const stage4 = stage4_pairs.flat();

/* ========= 進行 ========= */
let stage = 1; // 1→2→3→4→結果
let index = 0;
const answers = []; // {stage,q,...payload}

/* ========= 描画 ========= */
render();

function listForStage(){
  return stage===1?stage1 : stage===2?stage2 : stage===3?stage3 : stage4;
}
function stageExplain(s){
  return {
    1:`<div class="stage">第1段階：根っこの愛着スタイル（過去の自分）</div>
        <div class="small">当時の「実際の行動」に最も近いものを選んでください。</div>`,
    2:`<div class="stage">第2段階：成長・改善度</div>
        <div class="small">昔の自分と今の自分を比べて、“どれだけ出来るようになったか”で選んでください。</div>`,
    3:`<div class="stage">第3段階：ストレス下の安定</div>
        <div class="small">強い不安や一人のときでも保てる安定度を選んでください。</div>`,
    4:`<div class="stage">第4段階：隠れタイプ（A=普段 / B=恋愛中）</div>
        <div class="small">同じテーマでA→Bの順に答え、恋愛中に上がるリスクを見ます。</div>`,
  }[s];
}

function render(){
  const list = listForStage();
  app.innerHTML = '<div class="h1">4段階愛着診断</div><div id="error"></div>';

  if(index >= list.length){
    if(stage < 4){ stage++; index=0; return render(); }
    return renderResult();
  }

  if(index===0){
    app.appendChild(divCard(stageExplain(stage)));
  }

  app.appendChild(progressCard(index, list.length));

  const q = list[index];
  const card = document.createElement("div");
  card.className = "card";
  const h2 = document.createElement("h2");
  h2.className = "q"; h2.textContent = q.stem;
  card.appendChild(h2);

  const choices = document.createElement("div");
  choices.className = "choices";
  q.choices.forEach(c=>{
    const btn = document.createElement("button");
    btn.className = "choice";
    btn.textContent = c.label;
    btn.onclick = () => {
      const pos = answers.findIndex(a=>a.stage===stage && a.q===index);
      const payload = (c.kind==="imp")   ? {imp:c.imp}
                   : (c.kind==="stb")   ? {stable:c.stable}
                   : (c.kind==="risk")  ? {pairId:q.pairId, ab:q.ab, risk:c.risk, flavor:c.flavor}
                   : /* 第1段階 */       {style:c.style, pt:c.pt};
      const rec = { stage, q:index, ...payload };
      if(pos>=0) answers.splice(pos,1,rec); else answers.push(rec);
      [...choices.children].forEach(x=>x.classList.remove("selected"));
      btn.classList.add("selected");
      nextBtn.disabled = false;
    };
    choices.appendChild(btn);
  });
  card.appendChild(choices);

  const nav = document.createElement("div");
  nav.className = "nav";
  const back = document.createElement("button");
  back.className = "btn btn-ghost";
  back.textContent = "戻る";
  back.onclick = () => { if(index>0){ index--; render(); } };
  const nextBtn = document.createElement("button");
  nextBtn.className = "btn btn-primary";
  nextBtn.textContent = (index+1===list.length && stage===4) ? "結果を見る" : "次へ";
  nextBtn.disabled = answers.findIndex(a=>a.stage===stage && a.q===index) < 0;
  nextBtn.onclick = () => { index++; render(); };
  nav.append(back,nextBtn);
  card.appendChild(nav);

  app.appendChild(card);
}

/* ========= 集計 ========= */
function computeStage1(){
  const picked = answers.filter(a=>a.stage===1);
  const sum = {anxious:0,avoidant:0,fearful:0,secure:0};
  picked.forEach(a=>{ sum[a.style]+=a.pt; });
  const max = (stage1.length||1)*3;
  const pct = {
    anxious: Math.round((sum.anxious/max)*100),
    avoidant: Math.round((sum.avoidant/max)*100),
    fearful:  Math.round((sum.fearful /max)*100),
    secure:   Math.round((sum.secure  /max)*100),
  };
  const radar = Object.fromEntries(Object.entries(pct).map(([k,v])=>[k, Math.min(100, v+10)]));
  const domKey = Object.entries(pct).sort((a,b)=>b[1]-a[1])[0]?.[0] ?? "anxious";
  return { pct, radar, domKey, domLabel: STY[domKey] };
}
function computeStage2(){
  const picked=answers.filter(a=>a.stage===2);
  const got=picked.reduce((s,a)=>s+(a.imp??0),0);
  const max=picked.length*3;
  const pct=max?Math.round((got/max)*100):0;
  return { growthPct:pct };
}
function computeStage3(){
  const picked=answers.filter(a=>a.stage===3);
  const got=picked.reduce((s,a)=>s+(a.stable??0),0);
  const max=picked.length*3;
  const pct=max?Math.round((got/max)*100):0;
  let label="やや弱い";
  if(pct>=75) label="強い";
  else if(pct>=55) label="ふつう";
  else if(pct>=35) label="やや弱い";
  else label="弱い";
  return { stressPct:pct, stressLabel:label };
}
function computeStage4(){
  const p=answers.filter(a=>a.stage===4);
  const groups={};
  for(const a of p){
    if(!groups[a.pairId]) groups[a.pairId]={A:null,B:null,flavor:null};
    if(a.ab==="A") groups[a.pairId].A=a.risk;
    if(a.ab==="B") groups[a.pairId].B=a.risk;
    if(!groups[a.pairId].flavor && a.flavor) groups[a.pairId].flavor=a.flavor;
  }
  let anxUp=0, avoUp=0, bigSwing=0;
  Object.values(groups).forEach(g=>{
    if(g.A==null||g.B==null) return;
    const diff=g.B-g.A;
    if(diff>0){
      if(g.flavor==='anx') anxUp+=diff;
      if(g.flavor==='avo') avoUp+=diff;
      if(diff>=2) bigSwing++;
    }
  });
  let hidden="揺らぎ小";
  if(anxUp===0 && avoUp===0) hidden="揺らぎなし";
  else if(anxUp>avoUp) hidden="隠れ：不安寄り";
  else if(avoUp>anxUp) hidden="隠れ：回避寄り";
  if(bigSwing>=2) hidden+="（強）";
  return { hiddenLabel:hidden, anxUp, avoUp };
}

/* ========= 結果画面 ========= */
function renderResult(){
  app.innerHTML = '<div class="h1">診断結果</div><div id="error"></div>';

  const r1=computeStage1();
  const r2=computeStage2();
  const r3=computeStage3();
  const r4=computeStage4();

  const top=document.createElement("div"); top.className="result-grid";
  top.appendChild(divCard(`<div class="kpi">優勢タイプ：<b>${r1.domLabel}</b></div>`));
  top.appendChild(divCard(`<div class="kpi">第2段階 成長度：<b>${r2.growthPct}%</b></div>`));
  top.appendChild(divCard(`<div class="kpi">第3段階 ストレス耐性：<b>${r3.stressPct}%（${r3.stressLabel}）</b></div>`));
  top.appendChild(divCard(`<div class="kpi">第4段階 隠れタイプ：<b>${r4.hiddenLabel}</b></div>`));
  app.appendChild(top);

  const radarCard=divCard('<div class="badge">レーダーチャート（第1段階）</div><div class="hr"></div><canvas id="radar" height="260"></canvas>');
  app.appendChild(radarCard);
  new Chart(document.getElementById('radar'),{
    type:'radar',
    data:{ labels:["不安","回避","恐れ回避","安定"],
      datasets:[{ data:[r1.radar.anxious,r1.radar.avoidant,r1.radar.fearful,r1.radar.secure],
        fill:true, borderColor:"rgba(244,63,94,1)", backgroundColor:"rgba(244,63,94,.22)", pointRadius:3, borderWidth:2 }] },
    options:{ responsive:true, plugins:{legend:{display:false}},
      scales:{ r:{ suggestedMin:0, suggestedMax:100, ticks:{stepSize:25, backdropColor:"transparent"},
        grid:{color:"rgba(244,63,94,.15)"}, angleLines:{color:"rgba(244,63,94,.25)"} } }
  });

  const bd=divCard(`
    <div class="badge">ブレイクダウン</div><div class="hr"></div>
    <div class="result-grid">
      <div class="kpi">不安：<b>${r1.pct.anxious}%</b></div>
      <div class="kpi">回避：<b>${r1.pct.avoidant}%</b></div>
      <div class="kpi">恐れ回避：<b>${r1.pct.fearful}%</b></div>
      <div class="kpi">安定：<b>${r1.pct.secure}%</b></div>
    </div>
  `);
  app.appendChild(bd);

  app.appendChild(divCard('<div class="center"><button class="btn btn-ghost" onclick="location.reload()">最初からやり直す</button></div>'));
}

})();
</script>
</body>
</html>
