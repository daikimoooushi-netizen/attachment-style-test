<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>4段階愛着診断</title>
  <!-- Chart.js for radar -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --rose50:#fff1f2; --rose100:#ffe4e6; --rose200:#fecdd3; --rose300:#fda4af;
      --rose400:#fb7185; --rose500:#f43f5e; --rose600:#e11d48; --ink:#7f1d1d;
      --txt:#9f1239;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Yu Gothic",ui-sans-serif,Segoe UI,Roboto,Helvetica,Arial; color:#1f2937; background:
      linear-gradient(#fff, #fff) 0 0/100% 80px no-repeat,
      repeating-linear-gradient(180deg, #fee2e2 0 64px, #fff5f5 64px 128px);}
    .wrap{max-width:860px;margin:0 auto;padding:24px 16px 56px}
    h1{margin:8px 0 6px; font-size:28px; color:var(--ink); text-align:center; font-weight:800;}
    .progress{margin:18px 0 20px; background:#fff; border:1px solid #fbcfe8; border-radius:18px; padding:14px 16px}
    .progress .row{display:flex; justify-content:space-between; align-items:center; font-size:13px; color:#6b7280; margin-bottom:8px}
    .bar{height:8px; background:var(--rose100); border-radius:999px; overflow:hidden; position:relative}
    .bar>i{display:block; height:8px; width:0%; background:var(--rose400); border-radius:999px; transition:width .2s}
    .card{background:#fff; border:1px solid #fecdd3; border-radius:18px; padding:16px; box-shadow:0 1px 6px rgba(244,63,94,.08)}
    .stage{font-size:14px; color:#be123c; font-weight:700; margin:4px 4px 8px}
    .q{font-size:24px; color:#b91c1c; font-weight:800; line-height:1.5; margin:8px 6px 14px}
    .choices{display:grid; gap:12px; margin-top:8px}
    .choice{border:1px solid #fecdd3; background:#f8fafc; color:#2563eb; font-weight:600;
      border-radius:16px; padding:18px 20px; text-align:left; cursor:pointer}
    .choice:hover{border-color:#fda4af}
    .choice.selected{background:#fff1f2; border-color:#fb7185; color:#1d4ed8}
    .row{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:18px}
    .btn{border:none; border-radius:14px; padding:12px 20px; color:#fff; background:var(--rose500); font-weight:700; cursor:pointer}
    .btn:hover{background:var(--rose600)}
    .btn[disabled]{background:#fecaca; cursor:not-allowed}
    .btn-ghost{border:1px solid #fecdd3; background:#fff; color:#ef4444; font-weight:800}
    .muted{color:#9ca3af; font-size:12px; text-align:center; margin-top:6px}
    /* 結果 */
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .pill{background:#fff; border:1px solid #fecdd3; border-radius:14px; padding:12px 14px}
    .sum{background:#fff; border:1px solid #fecdd3; border-radius:16px; padding:14px; color:#9f1239; font-weight:700}
    @media (max-width:640px){
      .grid2{grid-template-columns:1fr}
      .q{font-size:20px}
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <h1>4段階愛着診断</h1>

    <!-- 進捗 -->
    <div class="progress">
      <div class="row">
        <div>進捗</div>
        <div id="counter">1/1 (0%)</div>
      </div>
      <div class="bar"><i id="bar"></i></div>
    </div>

    <!-- 質問カード／結果の差し替え先 -->
    <div id="screen" class="card"></div>
  </div>

  <script>
    // ========= 質問データ（まずはサンプル3問：ここに増やしていけます） =========
    // ※総問数は QUESTIONS.length を使うので、増やせば進捗の分母も自動で更新されます
    const QUESTIONS = [
      {
        id:"s1-01", stage:1,
        stageTitle:"第1段階：根っこの愛着スタイル（過去の自分で回答）",
        stem:"過去の恋愛で、好きな人から返信が遅れたとき",
        choices:[
          { id:"A", label:"不安が強まり、相手の反応ばかり気になった" },      // 不安
          { id:"B", label:"期待して傷つかないように距離を取った" },            // 回避
          { id:"C", label:"近づきたいのに怖くて動けなかった" },                // 恐れ回避
          { id:"D", label:"状況を受け止めて落ち着いて待てた" }                 // 安定
        ]
      },
      {
        id:"s1-02", stage:1,
        stageTitle:"第1段階：根っこの愛着スタイル（過去の自分で回答）",
        stem:"恋人とケンカになったとき",
        choices:[
          { id:"A", label:"感情的にぶつかってしまった" },
          { id:"B", label:"連絡を減らす/無視して距離を取った" },
          { id:"C", label:"何も言えず我慢してしまった" },
          { id:"D", label:"タイミングを見て冷静に話し合った" }
        ]
      },
      {
        id:"s1-03", stage:1,
        stageTitle:"第1段階：根っこの愛着スタイル（過去の自分で回答）",
        stem:"相手が『一人の時間が欲しい』と言ったとき",
        choices:[
          { id:"A", label:"『嫌われた？』と強い不安に襲われた" },
          { id:"B", label:"『じゃあ私も自由にする』と突き放した" },
          { id:"C", label:"表面上は受け入れたが内心は寂しさでいっぱい" },
          { id:"D", label:"理解して自分の時間を大切にできた" }
        ]
      }
    ];

    // ========= 状態 =========
    let index = 0;
    const answers = new Map();   // questionId -> choiceId
    const screen = document.getElementById("screen");
    const bar = document.getElementById("bar");
    const counter = document.getElementById("counter");

    function updateProgress(){
      const total = QUESTIONS.length;
      const cur = Math.min(index+1, total);
      const pct = Math.round((cur/total)*100);
      bar.style.width = pct + "%";
      counter.textContent = `${cur}/${total} (${pct}%)`;
    }

    function renderQuestion(){
      const q = QUESTIONS[index];
      updateProgress();

      const root = document.createElement("div");

      const st = document.createElement("div");
      st.className = "stage";
      st.textContent = q.stageTitle;
      root.appendChild(st);

      const h = document.createElement("div");
      h.className = "q";
      h.innerHTML = q.stem.replace(/\n/g,"<br>");
      root.appendChild(h);

      const list = document.createElement("div");
      list.className = "choices";
      q.choices.forEach((c, i)=>{
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = c.label;
        btn.onclick = ()=>{
          answers.set(q.id, c.id);
          // 選択表示
          Array.from(list.children).forEach(el=>el.classList.remove("selected"));
          btn.classList.add("selected");
          // 次へ有効
          nextBtn.disabled = false;
          warn.textContent = "";
        };
        list.appendChild(btn);
      });
      root.appendChild(list);

      const nav = document.createElement("div");
      nav.className = "row";

      const back = document.createElement("button");
      back.className = "btn-ghost";
      back.textContent = "戻る";
      back.onclick = ()=>{
        if(index>0){ index--; draw(); }
      };
      back.disabled = index===0;
      nav.appendChild(back);

      const warn = document.createElement("div");
      warn.className = "muted";
      warn.style.flex = "1";
      nav.appendChild(warn);

      const nextBtn = document.createElement("button");
      nextBtn.className = "btn";
      nextBtn.textContent = (index===QUESTIONS.length-1) ? "結果を見る" : "次へ";
      nextBtn.disabled = !answers.has(q.id);
      nextBtn.onclick = ()=>{
        if(!answers.has(q.id)){
          warn.textContent = "未回答のまま次へは進めません";
          return;
        }
        if(index===QUESTIONS.length-1){ renderResult(); }
        else { index++; draw(); }
      };
      nav.appendChild(nextBtn);

      root.appendChild(nav);
      screen.replaceChildren(root);
    }

    // ========= 結果計算 & レーダー表示 =========
    function computeStyleScore(){
      // A=不安 / B=回避 / C=恐れ回避 / D=安定 として簡易集計
      let a=0,b=0,c=0,d=0;
      for(const q of QUESTIONS){
        const ch = answers.get(q.id);
        if(ch==="A") a++;
        else if(ch==="B") b++;
        else if(ch==="C") c++;
        else if(ch==="D") d++;
      }
      const total = Math.max(1, a+b+c+d);
      const pct = x => Math.round((x/total)*100);
      return { anxious:pct(a), avoidant:pct(b), fearful:pct(c), secure:pct(d) };
    }

    function renderResult(){
      updateProgress();
      const s = computeStyleScore();

      const root = document.createElement("div");

      const title = document.createElement("div");
      title.className = "q";
      title.textContent = "診断結果";
      root.appendChild(title);

      const grid = document.createElement("div");
      grid.className = "grid2";
      grid.innerHTML = `
        <div class="pill">不安型：${s.anxious}%</div>
        <div class="pill">回避型：${s.avoidant}%</div>
        <div class="pill">恐れ回避型：${s.fearful}%</div>
        <div class="pill">安定型：${s.secure}%</div>
      `;
      root.appendChild(grid);

      const canvasWrap = document.createElement("div");
      canvasWrap.className = "card";
      canvasWrap.style.marginTop = "12px";
      const cv = document.createElement("canvas");
      cv.height = 260;
      canvasWrap.appendChild(cv);
      root.appendChild(canvasWrap);

      const sum = document.createElement("div");
      sum.className = "sum";
      const dom = Object.entries(s).sort((x,y)=>y[1]-x[1])[0][0];
      const labelMap = {
        anxious:"成長中の不安型。改善は進んでいるが、恋愛中は再燃しやすいタイプ。",
        avoidant:"距離を取りがちな回避型。対話の練習と感情の言語化が鍵。",
        fearful:"近づきたいのに怖い恐れ回避型。安心感の土台づくりを優先。",
        secure:"安定型の傾向。今のやり方を継続できればさらに安定。"
      };
      sum.textContent = `総合判定：${labelMap[dom]}`;
      root.appendChild(sum);

      // ボタン（最初から）
      const nav = document.createElement("div");
      nav.className = "row";
      const back = document.createElement("button");
      back.className = "btn-ghost";
      back.textContent = "最初からやり直す";
      back.onclick = ()=>{ answers.clear(); index=0; draw(); };
      nav.appendChild(back);
      root.appendChild(nav);

      screen.replaceChildren(root);

      // Radar
      new Chart(cv.getContext("2d"),{
        type:"radar",
        data:{
          labels:["不安","回避","恐れ回避","安定"],
          datasets:[{
            label:"スタイル比率",
            data:[s.anxious,s.avoidant,s.fearful,s.secure],
            fill:true, borderWidth:2,
            borderColor:"rgba(244,63,94,.9)", backgroundColor:"rgba(244,63,94,.15)",
            pointBackgroundColor:"rgba(244,63,94,1)"
          }]
        },
        options:{
          responsive:true, plugins:{ legend:{ display:false }},
          scales:{ r:{
            suggestedMin:0, suggestedMax:100, ticks:{ stepSize:25, showLabelBackdrop:false },
            grid:{ color:"rgba(251,113,133,.25)" }
          }}
        }
      });
    }

    function draw(){ renderQuestion(); }

    // 初期描画
    draw();
  </script>
</body>
</html>
