<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>4段階愛着診断</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
:root{
  --rose50:#fff1f2; --rose100:#ffe4e6; --rose200:#fecdd3; --rose300:#fda4af;
  --rose400:#fb7185; --rose500:#f43f5e; --rose600:#e11d48; --text:#7f1d1d
}
*{box-sizing:border-box} body{
  margin:0; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Hiragino Kaku Gothic ProN, Yu Gothic, Meiryo, system-ui, sans-serif;
  color:#3f3f46; background:linear-gradient(#fff, var(--rose50))
}
.wrap{max-width:940px; margin:0 auto; padding:20px 16px 56px}
.h1{font-weight:800; color:var(--rose600); font-size:clamp(22px,4vw,32px); text-align:center; margin:18px 0 6px}
.card{background:#fff; border:1px solid var(--rose200); border-radius:18px; padding:16px 14px; box-shadow: 0 0 0 1px rgba(244,63,94,.04), 0 8px 28px rgba(244,63,94,.06)}
.card + .card{ margin-top:14px }
h2.q{font-weight:800; line-height:1.5; letter-spacing:.02em; color:#991b1b; margin:6px 2px 14px}
.stage{font-weight:700; font-size:13px; color:#be123c; margin:0 2px 8px}
.small{ font-size:12px; color:#6b7280 }
.mini{display:flex; justify-content:space-between; font-size:12px; color:#fb7185; margin-bottom:6px}
.progress{height:8px; background:var(--rose100); border-radius:999px; overflow:hidden}
.progress>div{ height:100%; background:var(--rose400) }
.choices{display:flex; flex-direction:column; gap:10px}
.choice{
  border:1px solid var(--rose200); background:#fff; border-radius:14px; padding:14px 12px; text-align:left; font-size:15px;
  cursor:pointer; transition:.15s box-shadow,.15s transform,.15s border-color
}
.choice:hover{ border-color:var(--rose300); transform:translateY(-1px) }
.choice.selected{ border-color:var(--rose400); background:linear-gradient(#fff, #fff5f6) }
.nav{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:16px}
.btn{ border:none; border-radius:12px; padding:10px 16px; font-weight:700; cursor:pointer }
.btn-ghost{ background:#fff; border:1px solid var(--rose200) }
.btn-primary{ background:var(--rose500); color:#fff }
.btn-primary:disabled{ background:var(--rose300); cursor:not-allowed }
.result-grid{ display:grid; gap:10px }
.kpi{ background:#fff; border:1px solid var(--rose200); border-radius:14px; padding:10px 12px }
.kpi b{ color:#be123c }
.badge{ display:inline-block; background:#fff; border:1px solid var(--rose200); color:#be123c; border-radius:999px; padding:6px 10px; font-weight:700 }
.hr{ height:1px; background:var(--rose200); margin:14px 0 }
.center{text-align:center}
.notice{ font-size:12px; color:#6b7280; margin-top:6px }
</style>
</head>
<body>
<div class="wrap" id="app"></div>

<script>
/* ========= ラベル & ユーティリティ ========= */
const STY = { anxious:'不安', avoidant:'回避', fearful:'恐れ回避', secure:'安定' };
const W = { strong:3, mid:2, weak:1, stable:0 };
const app = document.getElementById('app');

function el(tag, cls, html){
  const n=document.createElement(tag); if(cls) n.className=cls; if(html!=null) n.innerHTML=html; return n;
}
function chS1(label, style, strength){ return { kind:'s1', label, style, pt: W[strength] }; }
function chImp(label, imp){ return { kind:'imp', label, imp }; }      // 0〜3（高いほど成長）
function chStb(label, stable){ return { kind:'stb', label, stable }; } // 0〜3（高いほど安定）
function chRisk(label, risk, flavor){ return { kind:'risk', label, risk, flavor }; } // 0〜3（高いほどリスク） flavor='anx'|'avo'

/* ========= 第1段階：60問（既存） ========= */
/* — ここはあなたが既に入れた60問を残したまま — */
/* 便宜上、ここでは省略せず最初の関数から生成します（先に貼った版をそのまま使ってOK） */
const stage1 = (()=>{ 
  // ……（前回お渡しした60問の配列そのまま）……
  // ここでは紙幅都合で省略しますが、あなたのリポジトリにある stage1 をそのまま残して下さい。
  // ↓最初の20問だけ例でダミー化（実運用はあなたの60問を置いてください）
  const demo20 = Array.from({length:20},(_,i)=>({
    stem:`（デモ）第1の設問 ${i+1}`,
    choices:[
      chS1("不安な反応", "anxious", "mid"),
      chS1("回避的に距離", "avoidant","mid"),
      chS1("恐れ回避で沈黙","fearful","mid"),
      chS1("安定に対処","secure","stable"),
    ]
  }));
  // 実運用では demo20 を削除し、あなたの 60問配列を返してください。
  return demo20;
})();

/* ========= 第2段階：成長・改善度（サンプル6問→拡張して20問に） ========= */
/* imp: 0=変化なし/悪化, 1=少し成長, 2=かなり成長, 3=大きく成長 */
const stage2 = [
  {
    stem: "昔より、不安を感じた時に自分で落ち着けるようになった？",
    choices: [
      chImp("ほとんど変わらない",0),
      chImp("少しできるようになった",1),
      chImp("かなり落ち着ける",2),
      chImp("ほぼ自動で整えられる",3),
    ]
  },
  {
    stem: "依存的な行動（追撃LINEなど）は以前と比べて？",
    choices: [
      chImp("変わっていない/増えた",0),
      chImp("やや減った",1),
      chImp("だいぶ減った",2),
      chImp("ほとんどなくなった",3),
    ]
  },
  {
    stem: "相手への率直な気持ちの伝達は？",
    choices: [
      chImp("ほぼ出来ない",0),
      chImp("短くなら伝えられる",1),
      chImp("具体で伝えられる",2),
      chImp("タイミングも選べる",3),
    ]
  },
  {
    stem: "相手を疑う気持ちの扱いは？",
    choices: [
      chImp("疑いが強く同じ行動を繰り返す",0),
      chImp("衝動は減った",1),
      chImp("疑いを言語化して話せる",2),
      chImp("疑いに飲まれず選べる",3),
    ]
  },
  {
    stem: "衝突時に感情をぶつけず話し合える？",
    choices: [
      chImp("ぶつけてしまう",0),
      chImp("たまに落ち着ける",1),
      chImp("かなり落ち着ける",2),
      chImp("目的思考で対話できる",3),
    ]
  },
  {
    stem: "相手の『一人時間ほしい』への受け止めは？",
    choices: [
      chImp("不安で崩れる",0),
      chImp("我慢して合わせる",1),
      chImp("理解しつつ自分も整える",2),
      chImp("自然に尊重しつつ過ごせる",3),
    ]
  },
  // ←この要領で 20 問まで増やしてOK
];

/* ========= 第3段階：ストレス下の安定（サンプル6問→20問に） ========= */
/* stable: 0=不安定, 1=やや不安定, 2=やや安定, 3=安定 */
const stage3 = [
  {
    stem: "好きな人から3日返信なし。あなたの反応は？",
    choices: [
      chStb("連投/パニック",0),
      chStb("諦めて距離",1),
      chStb("気にしつつ待つ",2),
      chStb("気になるが落ち着いて待つ",3),
    ]
  },
  {
    stem: "『少し距離を置きたい』と言われた",
    choices: [
      chStb("何度も連絡/詰める",0),
      chStb("冷めたふりで距離",1),
      chStb("不安抱えつつ様子見",2),
      chStb("受け止め自分時間へ",3),
    ]
  },
  {
    stem: "強い不安に襲われた時のセルフケア",
    choices: [
      chStb("相手へぶつける",0),
      chStb("投げやりに避ける",1),
      chStb("一人で抱える",1),
      chStb("呼吸/記録/再評価で整える",3),
    ]
  },
  {
    stem: "一人の休日、恋愛の事ばかり考える？",
    choices: [
      chStb("ずっと考えてしまう",0),
      chStb("長めに引きずる",1),
      chStb("切替できる時間がある",2),
      chStb("自分の活動に集中できる",3),
    ]
  },
  {
    stem: "SNSで不安になる頻度",
    choices: [
      chStb("頻繁にある",0),
      chStb("時々ある",1),
      chStb("たまにある",2),
      chStb("ほぼ無い",3),
    ]
  },
  {
    stem: "ケンカ時の対処",
    choices: [
      chStb("感情的に爆発する",0),
      chStb("無視/距離を取る",1),
      chStb("我慢して沈黙",1),
      chStb("休憩→合意形成の対話",3),
    ]
  },
  // ←この要領で 20 問まで増やしてOK
];

/* ========= 第4段階：隠れタイプ（10テーマ×A/B＝20問） ========= */
/* 同ペアの A=普段 / B=恋愛中 を pairId で結び、B-A のリスク上昇を集計。
   flavor= 'anx'（不安系リスク） or 'avo'（回避系リスク） */
const stage4 = [
  // pair1: 返信が遅い
  { pairId:'p1', ab:'A', stem:"（普段）返信が遅い状況での自分", choices:[
    chRisk("あまり気にしない",0,'anx'),
    chRisk("少し気になるが切替できる",1,'anx'),
    chRisk("落ち着かなくなることがある",2,'anx'),
    chRisk("不安になりやすい",3,'anx'),
  ]},
  { pairId:'p1', ab:'B', stem:"（恋愛中）好きな人の返信が遅い時", choices:[
    chRisk("落ち着いて待てる",0,'anx'),
    chRisk("気になるが待てる",1,'anx'),
    chRisk("何度も確認してしまう",2,'anx'),
    chRisk("嫌われ不安で連投したい",3,'anx'),
  ]},
  // pair2: 一人時間
  { pairId:'p2', ab:'A', stem:"（普段）一人時間の扱い", choices:[
    chRisk("自然に確保できる",0,'anx'),
    chRisk("時々不安になる",1,'anx'),
    chRisk("孤独感が出やすい",2,'anx'),
    chRisk("心細さが強い",3,'anx'),
  ]},
  { pairId:'p2', ab:'B', stem:"（恋愛中）相手に一人時間と言われたら", choices:[
    chRisk("尊重して待てる",0,'anx'),
    chRisk("少し不安だが整えられる",1,'anx'),
    chRisk("不安で落ち着かない",2,'anx'),
    chRisk("拒絶感でパニック",3,'anx'),
  ]},
  // pair3: 近接要求（回避）
  { pairId:'p3', ab:'A', stem:"（普段）親密な話題/距離が近い時", choices:[
    chRisk("大丈夫",0,'avo'),
    chRisk("少し逃げたくなる",1,'avo'),
    chRisk("避けがちになる",2,'avo'),
    chRisk("強く引きたくなる",3,'avo'),
  ]},
  { pairId:'p3', ab:'B', stem:"（恋愛中）相手が密に繋がりたがる時", choices:[
    chRisk("ペース相談できる",0,'avo'),
    chRisk("負担だが話せる",1,'avo'),
    chRisk("返信/会う頻度を下げる",2,'avo'),
    chRisk("急に距離を空ける",3,'avo'),
  ]},
  // pair4〜pair10 もこの要領で追加可能（計10ペア=20問）
];

/* ========= 進行管理 ========= */
let stage = 1;   // 1→2→3→4
let index = 0;   // 各ステージのインデックス
const answers = []; // {stage, q, payload...}

/* ========= 画面描画 ========= */
render();

function listForStage(){
  return stage===1?stage1 : stage===2?stage2 : stage===3?stage3 : stage4;
}

function render(){
  const list = listForStage();
  app.innerHTML = "";

  // ステージ終了 → 次のステージ or 結果
  if(index >= list.length){
    if(stage < 4){ stage++; index=0; return render(); }
    return renderResult();
  }

  // 見出し
  app.appendChild(el("div","",`<div class="h1">4段階愛着診断</div>`));

  // ステージ説明
  const explain = {
    1:`<div class="stage">第1段階：根っこの愛着スタイル（過去の自分）</div>
        <div class="small">当時の「実際の行動」に近いものを選んでください。</div>`,
    2:`<div class="stage">第2段階：成長・改善度</div>
        <div class="small">昔の自分と今の自分を比べた“変化”を選んでください。</div>`,
    3:`<div class="stage">第3段階：ストレス下の安定</div>
        <div class="small">高ストレスや一人のときでも保てる安定度を選んでください。</div>`,
    4:`<div class="stage">第4段階：隠れタイプ（A=普段 / B=恋愛中）</div>
        <div class="small">同じテーマでA→Bの順に答えてください。恋愛中で上がるリスクを測ります。</div>`
  };
  if(index===0){
    app.appendChild(el("div","card",explain[stage]));
  }

  // 進捗
  app.appendChild(el("div","card",`
    <div class="mini"><div>進捗</div><div>${index+1}/${list.length}（${Math.round(((index+1)/list.length)*100)}%）</div></div>
    <div class="progress"><div style="width:${((index+1)/list.length)*100}%"></div></div>
  `));

  // 質問
  const q = list[index];
  const card=el("div","card");
  card.appendChild(el("h2","q", q.stem));

  const choices=el("div","choices");
  q.choices.forEach((c)=>{
    const btn=el("button","choice",c.label);
    btn.onclick=()=>{
      // 保存（同問は上書き）
      const pos=answers.findIndex(a=>a.stage===stage && a.q===index);
      const payload = (c.kind==='s1')? {style:c.style, pt:c.pt}
                  : (c.kind==='imp')? {imp:c.imp}
                  : (c.kind==='stb')? {stable:c.stable}
                  : (c.kind==='risk')? {pairId:q.pairId, ab:q.ab, risk:c.risk, flavor:c.flavor}
                  : {};
      const rec = {stage, q:index, ...payload};
      if(pos>=0) answers.splice(pos,1,rec); else answers.push(rec);
      // UI反映
      [...choices.children].forEach(x=>x.classList.remove('selected'));
      btn.classList.add('selected');
      nextBtn.disabled=false;
    };
    choices.appendChild(btn);
  });
  card.appendChild(choices);

  // ナビ
  const nav=el("div","nav");
  const back=el("button","btn btn-ghost","戻る");
  back.onclick=()=>{ if(index>0){ index--; render(); } };
  const nextBtn=el("button","btn btn-primary", (index+1===list.length && stage===4)?"結果を見る":"次へ");
  nextBtn.disabled = answers.findIndex(a=>a.stage===stage && a.q===index) < 0;
  nextBtn.onclick=()=>{ index++; render(); };
  nav.append(back,nextBtn);
  card.appendChild(nav);

  app.appendChild(card);
}

/* ========= 集計 ========= */
// 第1：スタイル％＋レーダー用拡張
function computeStage1(){
  const picked = answers.filter(a=>a.stage===1);
  const sum = {anxious:0, avoidant:0, fearful:0, secure:0};
  picked.forEach(a=>{ sum[a.style]+=a.pt; });
  const maxPossible = stage1.length * W.strong;
  const pct = {
    anxious: Math.round((sum.anxious/maxPossible)*100),
    avoidant: Math.round((sum.avoidant/maxPossible)*100),
    fearful:  Math.round((sum.fearful /maxPossible)*100),
    secure:   Math.round((sum.secure  /maxPossible)*100),
  };
  const radar = Object.fromEntries(Object.entries(pct).map(([k,v])=>[k, Math.min(100,v+10)]));
  const domKey = Object.entries(pct).sort((a,b)=>b[1]-a[1])[0][0];
  return { pct, radar, domKey, domLabel: STY[domKey] };
}

// 第2：改善度％
function computeStage2(){
  const picked = answers.filter(a=>a.stage===2);
  const got = picked.reduce((s,a)=>s+(a.imp??0),0);
  const max = picked.length * 3;
  const pct = max? Math.round((got/max)*100):0;
  return { growthPct:pct };
}

// 第3：ストレス耐性％＋ラベル
function computeStage3(){
  const picked = answers.filter(a=>a.stage===3);
  const got = picked.reduce((s,a)=>s+(a.stable??0),0);
  const max = picked.length*3;
  const pct = max? Math.round((got/max)*100):0;
  let label = "やや弱い";
  if(pct>=75) label="強い";
  else if(pct>=55) label="ふつう";
  else if(pct>=35) label="やや弱い";
  else label="弱い";
  return { stressPct:pct, stressLabel:label };
}

// 第4：隠れタイプ
function computeStage4(){
  const p = answers.filter(a=>a.stage===4);
  const groups = {};
  for(const a of p){
    if(!groups[a.pairId]) groups[a.pairId]={ A:null, B:null, flavor:null };
    if(a.ab==='A') groups[a.pairId].A = a.risk;
    if(a.ab==='B') groups[a.pairId].B = a.risk;
    if(!groups[a.pairId].flavor && a.flavor) groups[a.pairId].flavor = a.flavor;
  }
  let anxUp=0, avoUp=0, total=0, bigSwing=0;
  Object.values(groups).forEach(g=>{
    if(g.A==null || g.B==null) return;
    const diff = (g.B - g.A);
    if(diff>0){
      if(g.flavor==='anx') anxUp += diff;
      if(g.flavor==='avo') avoUp += diff;
      if(diff>=2) bigSwing++;
    }
    total++;
  });
  let hidden = "揺らぎ小";
  if(anxUp===0 && avoUp===0) hidden="揺らぎなし";
  else if(anxUp>avoUp) hidden="隠れ：不安寄り";
  else if(avoUp>anxUp) hidden="隠れ：回避寄り";
  if(bigSwing>=2) hidden += "（強）";
  return { hiddenLabel:hidden, anxUp, avoUp };
}

/* ========= 結果画面 ========= */
function renderResult(){
  app.innerHTML="";
  app.appendChild(el("div","",`<div class="h1">診断結果</div>`));

  const r1 = computeStage1();
  const r2 = computeStage2();
  const r3 = computeStage3();
  const r4 = computeStage4();

  // 上部KPI
  const head=el("div","result-grid");
  head.appendChild(el("div","kpi",`優勢タイプ：<b>${r1.domLabel}</b>`));
  head.appendChild(el("div","kpi",`第2段階 成長度：<b>${r2.growthPct}%</b>`));
  head.appendChild(el("div","kpi",`第3段階 ストレス耐性：<b>${r3.stressPct}%（${r3.stressLabel}）</b>`));
  head.appendChild(el("div","kpi",`第4段階 隠れタイプ：<b>${r4.hiddenLabel}</b>`));
  app.appendChild(head);

  // レーダー
  const radarCard=el("div","card");
  radarCard.innerHTML = `<div class="badge">レーダーチャート（第1段階）</div><div class="hr"></div><canvas id="radar" height="260"></canvas>`;
  app.appendChild(radarCard);
  new Chart(document.getElementById('radar'),{
    type:'radar',
    data:{
      labels:[STY.anxious,STY.avoidant,STY.fearful,STY.secure],
      datasets:[{ data:[r1.radar.anxious,r1.radar.avoidant,r1.radar.fearful,r1.radar.secure], fill:true, pointRadius:3 }]
    },
    options:{ responsive:true, plugins:{legend:{display:false}},
      scales:{ r:{ suggestedMin:0, suggestedMax:100, ticks:{stepSize:25, backdropColor:'transparent'},
        grid:{color:'rgba(244,63,94,.15)'}, angleLines:{color:'rgba(244,63,94,.25)'} } }
  });

  // ブレイクダウン
  const sum=el("div","card");
  sum.innerHTML = `
    <div class="badge">ブレイクダウン</div><div class="hr"></div>
    <div class="result-grid">
      <div class="kpi">不安：<b>${r1.pct.anxious}%</b></div>
      <div class="kpi">回避：<b>${r1.pct.avoidant}%</b></div>
      <div class="kpi">恐れ回避：<b>${r1.pct.fearful}%</b></div>
      <div class="kpi">安定：<b>${r1.pct.secure}%</b></div>
    </div>
    <div class="notice">※ 第2〜4段階は今後、設問を追加しても自動で集計に反映されます。</div>
  `;
  app.appendChild(sum);

  app.appendChild(el("div","center",`<button class="btn btn-ghost" onclick="location.reload()">最初からやり直す</button>`));
}
</script>
</body>
</html>
